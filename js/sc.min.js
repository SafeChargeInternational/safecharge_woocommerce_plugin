
var isAjaxCalled=false;var manualChangedCountry=false;var tokAPMs=["cc_card","paydotcom"];var tokAPMsFields={cardNumber:"ccCardNumber",expirationMonth:"ccExpMonth",expirationYear:"ccExpYear",cardHolderName:"ccNameOnCard",CVV:""};var selectedPM="";var billing_country_first_val="";function scValidateAPMFields(){var a=true;if(jQuery("li.apm_container").length>0){jQuery("li.apm_container").each(function(){var e=jQuery(this);var d=e.find("input.sc_payment_method_field");if(d.is(":checked")){var c=e.find(".apm_field input");selectedPM=d.val();if(typeof c.attr("pattern")!="undefined"&&c.attr("pattern")!==false&&c.attr("pattern")!=""){var f=new RegExp(c.attr("pattern"),"i");if(f.test(c.val())==false||c.val()==""){c.parent(".apm_field").find(".apm_error").removeClass("error_info").show();a=false}else{c.parent(".apm_field").find(".error").hide()}}}})}if(a){if(tokAPMs.indexOf(selectedPM)>-1){jQuery("#custom_loader").show();var b={merchantSiteId:"",sessionToken:"",billingAddress:{city:jQuery("#billing_city").val(),country:jQuery("#billing_country").val(),zip:jQuery("#billing_postcode").val(),email:jQuery("#billing_email").val(),firstName:jQuery("#billing_first_name").val(),lastName:jQuery("#billing_last_name").val(),},cardData:{cardNumber:jQuery("#"+selectedPM+"_"+tokAPMsFields.cardNumber).val(),cardHolderName:jQuery("#"+selectedPM+"_"+tokAPMsFields.cardHolderName).val(),expirationMonth:jQuery("#"+selectedPM+"_"+tokAPMsFields.expirationMonth).val(),expirationYear:jQuery("#"+selectedPM+"_"+tokAPMsFields.expirationYear).val(),CVV:null}};jQuery.ajax({type:"POST",url:myAjax.ajaxurl,data:{needST:1},dataType:"json"}).done(function(c){if(c.status==1&&typeof c.data!="undefined"){b.merchantSiteId=c.data.merchantId;b.sessionToken=c.data.sessionToken;if(c.data.test=="yes"){b.environment="test"}if(typeof Safecharge!="undefined"){Safecharge.card.createToken(b,safechargeResultHandler)}}})}else{jQuery("form.woocommerce-checkout").submit()}}}function safechargeResultHandler(b){if(b.status=="ERROR"){jQuery("#custom_loader").hide();var a="Error when try to proceed the payment. Please, check you fields!";if(typeof b.reason!="undefined"&&b.reason!=""){a=b.reason}jQuery("form.woocommerce-checkout").prepend('<ul class="woocommerce-error" role="alert"><li><strong>'+a+"</strong></li></ul>");window.location.hash="#main";window.location=window.location.hash}else{if(b.status=="SUCCESS"){jQuery("#"+selectedPM+"_"+tokAPMsFields.cardNumber).val(b.ccTempToken);jQuery("#custom_loader").hide();jQuery("form.woocommerce-checkout").append('<input type="hidden" name="lst", value="'+b.sessionToken+'" />').submit()}}}function showErrorLikeInfo(a){jQuery("#error_"+a).addClass("error_info");if(jQuery("#error_"+a).css("display")=="block"){jQuery("#error_"+a).hide()}else{jQuery("#error_"+a).show()}}function getAPMs(){if(jQuery("#billing_country").val()!=billing_country_first_val){manualChangedCountry=true;billing_country_first_val=jQuery("#billing_country").val()}if(isAjaxCalled===false||manualChangedCountry===true){isAjaxCalled=true;jQuery.ajax({type:"POST",url:myAjax.ajaxurl,data:{country:jQuery("#billing_country").val()},dataType:"json"}).done(function(b){if(typeof b!="undefined"&&b!==null&&b.status==1&&typeof b.data.paymentMethods!="undefined"&&b.data.paymentMethods.length>0){var k="";var q=b.data.paymentMethods;k+='<ul id="sc_apms_list">';for(var g in q){var a="";if(q[g]["paymentMethodDisplayName"].length>0&&typeof q[g]["paymentMethodDisplayName"][0].message!="undefined"){a=q[g]["paymentMethodDisplayName"][0].message}var d=a;if(typeof q[g]["logoURL"]!="undefined"){d='<img src="'+q[g]["logoURL"].replace("/svg/","/svg/solid-white/")+'" alt="'+a+'">'}if(q[g].paymentMethod=="cc_card"){var h=true;for(var l in q[g].fields){if(q[g].fields[l].name.toLowerCase()=="cvv"){h=false;break}}if(h){q[g].fields.push({name:"CVV",regex:"^[0-9]{3,4}$",type:"number",validationmessage:[{message:"CVV must be 3 or 4 digits!",language:"en"}],caption:[{message:"CVV Number",language:"en"}]})}}k+='<li class="apm_container"><div class="apm_title">'+d+'<input id="sc_payment_method_'+q[g].paymentMethod+'" type="radio" class="input-radio sc_payment_method_field" name="payment_method_sc" value="'+q[g].paymentMethod+'" /><span class=""></span></div><div class="apm_fields">';if(q[g].fields.length>0){for(var c in q[g].fields){var o="";try{o=q[g].fields[c].regex;if(o===undefined){o=""}}catch(n){}var p="";try{p=q[g].fields[c].caption[0].message;if(p===undefined){p=""}}catch(n){}var m="";try{m=q[g].fields[c].validationmessage[0].message;if(m===undefined){m=""}}catch(n){}k+='<div class="apm_field"><input id="'+q[g].paymentMethod+"_"+q[g].fields[c].name+'" name="'+q[g].paymentMethod+"["+q[g].fields[c].name+']" type="'+q[g].fields[c].type+'" pattern="'+o+'" placeholder="'+p+'" autocomplete="new-password" />';if(o!=""){k+='<span class="question_mark" onclick="showErrorLikeInfo(\'sc_'+q[g].fields[c].name+'\')"><span class="tooltip-icon"></span></span><div class="apm_error" id="error_sc_'+q[g].fields[c].name+'"><label>'+m+"</label></div>"}k+="</div>"}}k+="</div></li>"}k+="</ul>";jQuery(document).on("updated_checkout",function(){jQuery("#payment").find(".sc_apms").remove();if(k!=""){if(jQuery(".payment_method_sc:last").find("ul#sc_apms_list").length>0){jQuery(".payment_method_sc:last").find("ul#sc_apms_list").remove()}jQuery(".payment_method_sc:last").append(k);jQuery('form[name="checkout"]').attr("onsubmit","return false;");jQuery("#payment").append('<div id="custom_loader" class="blockUI"></div>');jQuery("form.woocommerce-checkout button[type=submit]").attr("type","button").attr("onclick","scValidateAPMFields()")}})}else{if(b.status==0){jQuery("form.woocommerce-checkout").prepend('<ul class="woocommerce-error" role="alert"><li><strong>Error when try to get APMs. Please, try again later!</strong></li></ul>')}}})}}function cancelOrder(b,a){if(confirm(b)){jQuery("#custom_loader").show();jQuery.ajax({type:"POST",url:myAjax.ajaxurl,data:{cancelOrder:1},dataType:"json"}).done(function(c){if(typeof c.status!="undefined"&&(c.status==1||c.status==0)){jQuery.ajax({url:"//"+window.location.host+"/?wc-api=sc_listener&action=void&Status="+c.status+"&clientRequestId="+a+"&msg="+c.msg,dataType:"text"}).complete(function(d){jQuery("#custom_loader").hide();alert("You will be redirected to Orders list.");window.location="//"+window.location.host+"/wp-admin/edit.php?post_type=shop_order"})}})}}function deleteOldestLogs(){if(confirm("Are you sure you wanto to delete log files?")){jQuery("#custom_loader").show();jQuery("form#mainform #message").remove();jQuery.ajax({type:"POST",url:myAjax.ajaxurl,data:{deleteLogs:1},dataType:"json"}).done(function(a){if(a.status==1){jQuery("form#mainform h3").prepend('<div id="message" class="updated inline"><p><strong>Success.</strong></p></div>')}else{jQuery("form#mainform h3").prepend('<div id="message" class="error inline"><p><strong>Error: '+a.msg+"</strong></p></div>")}window.location.hash="#wpbody";window.location=window.location.hash;jQuery("#custom_loader").hide()})}}jQuery(function(){billing_country_first_val=jQuery("#billing_country").val();jQuery("#billing_country").change(function(){getAPMs()});jQuery("form.woocommerce-checkout").on("click",".apm_title",function(){jQuery("#sc_apms_list").find(".apm_title span").removeClass("apm_selected");jQuery("#sc_apms_list").find(".apm_fields").each(function(){var a=jQuery(this);if(a.css("display")=="block"){a.slideToggle("slow")}});jQuery(this).find("span").addClass("apm_selected");if(jQuery(this).parent("li").find(".apm_fields").html()==""){jQuery(this).parent("li").find(".apm_fields").css("border-bottom",0)}if(jQuery(this).parent("li").find(".apm_fields").css("display")=="none"){jQuery(this).parent("li").find(".apm_fields").slideToggle("slow")}jQuery("form.woocommerce-checkout").find("sc_payment_method_field").attr("checked",false);jQuery(this).find("input").attr("checked",true);jQuery(".apm_error").hide()});if(jQuery("body").find("form.woocommerce-checkout").length>0&&jQuery("form.woocommerce-checkout").find("#sc_apms_list").length==0){getAPMs()}});